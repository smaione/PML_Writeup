---
title: "Human Activity Recognition"
author: "smaione"
output: html_document
---


## Get the Data

```{r, cache=FALSE}
rm(list=ls()); par(mfrow=c(1, 1))
```

```{r, cache=TRUE}
trainURL <- paste("http://d396qusza40orc.cloudfront.net",
                 "/predmachlearn/pml-training.csv", sep="")
testURL <- paste("http://d396qusza40orc.cloudfront.net",
                 "/predmachlearn/pml-testing.csv", sep="")

download.file(trainURL, "./pml-training.csv")
download.file(testURL, "./pml-testing.csv")

train_data <- read.csv("./pml-training.csv", na.strings=c("", "NA"))
test_data <- read.csv("./pml-testing.csv", na.strings=c("", "NA"))
```


## Preprocess

```{r, cache=FALSE}
# remove ID variable
test_data <- test_data[, -160]

# remove first seven columns from each dataset
train_data <- train_data[, -1:-7]
test_data <- test_data[, -1:-7]

# create dummy variables based on the levels of classe
train_classe_A <- as.numeric(train_data$classe == 'A')
train_classe_B <- as.numeric(train_data$classe == 'B')
train_classe_C <- as.numeric(train_data$classe == 'C')
train_classe_D <- as.numeric(train_data$classe == 'D')
train_classe_E <- as.numeric(train_data$classe == 'E')

train_data <- train_data[, -which(names(train_data) == 'classe')]

# create placeholder classe variables for the test set
test_classe_A <- numeric(length = 20)
test_classe_B <- numeric(length = 20)
test_classe_C <- numeric(length = 20)
test_classe_D <- numeric(length = 20)
test_classe_E <- numeric(length = 20)

# remove any variables that may have missing data
missing_vals <- sapply(train_data, function(x) { sum(is.na(x)) })
complete_variables <- names(missing_vals[missing_vals == 0])

train_data <- train_data[, complete_variables]
test_data <- test_data[, complete_variables]

```

## Build Model

I am using classifaction trees with 10-fold cross validation.  I train a tree for each dummy variable that was created from the levels of original 'classe' factor.
```{r, cache=FALSE}
library(caret)

tree_A <- train(train_classe_A ~ ., method='rpart', data=train_data,
                trControl=trainControl(method='cv', number=10))
tree_B <- train(train_classe_B ~ ., method='rpart', data=train_data,
                trControl=trainControl(method='cv', number=10))
tree_C <- train(train_classe_C ~ ., method='rpart', data=train_data,
                trControl=trainControl(method='cv', number=10))
tree_D <- train(train_classe_D ~ ., method='rpart', data=train_data,
                trControl=trainControl(method='cv', number=10))
tree_E <- train(train_classe_E ~ ., method='rpart', data=train_data,
                trControl=trainControl(method='cv', number=10))
```


## Estimate the Accuracy

In order to estimate the accuracy of the model, I start by predicting on the training data using the best trees chosen from cross validation.  Each instance in the training set is given a prediction by each tree.
```{r, cache=FALSE}
in_sample_A <- predict(tree_A, train_data)
in_sample_B <- predict(tree_B, train_data)
in_sample_C <- predict(tree_C, train_data)
in_sample_D <- predict(tree_D, train_data)
in_sample_E <- predict(tree_E, train_data)
```

I choose the class with the highest predicted value as the final prediction.
```{r, cache=FALSE}
in_sample_pred <- data.frame(in_sample_A, in_sample_B, in_sample_C,
                             in_sample_D, in_sample_E)

in_sample_max <- apply(in_sample_pred, 1, which.max)
```


The accuracy is calculated from the ratio of number of misclassifications and actual classification.
```{r, cache=FALSE}
y <- train_data <- read.csv("./pml-training.csv",
                            na.strings=c("", "NA"))$classe
(in_sample_accuracy <- sum(as.numeric(y) == in_sample_max) / length(y))
```


## Test Prediction

Similar to predicting on the training data, I make a prediction for each test case for each tree.  The highest prediction is chosen as final.
```{r, cache=FALSE}
out_sample_A <- predict(tree_A, test_data)
out_sample_B <- predict(tree_B, test_data)
out_sample_C <- predict(tree_C, test_data)
out_sample_D <- predict(tree_D, test_data)
out_sample_E <- predict(tree_E, test_data)

out_sample_pred <- data.frame(out_sample_A, out_sample_B, out_sample_C,
                             out_sample_D, out_sample_E)

(out_sample_max <- apply(out_sample_pred, 1, which.max))
```